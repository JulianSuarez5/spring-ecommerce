<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content}, 'Carrito de Compras')}">
<head>
    <meta charset="UTF-8">
    <title>Carrito de Compras</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Encabezado de la Página -->
        <div class="bg-gradient-primary text-white py-4" style="background: var(--secondary-color);">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-5 fw-bold mb-2">
                            <i class="bi bi-cart3"></i> Mi Carrito de Compras
                        </h1>
                        <p class="lead mb-0">Revisa y gestiona tus productos</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <a href="/products" class="btn btn-light btn-lg">
                            <i class="bi bi-arrow-left"></i> Seguir Comprando
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container py-5">
            <!-- Mensaje de Carrito Vacío -->
            <div th:if="${#lists.isEmpty(cartItems)}" class="text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-cart-x" style="font-size: 5rem; color: #6c757d;"></i>
                </div>
                <h3 class="mb-3">Tu carrito está vacío</h3>
                <p class="text-muted mb-4">¡Agrega productos para comenzar tu compra!</p>
                <a href="/products" class="btn btn-primary btn-lg">
                    <i class="bi bi-shop"></i> Ver Productos
                </a>
            </div>

            <!-- Contenido del Carrito -->
            <div th:unless="${#lists.isEmpty(cartItems)}" class="row">
                <!-- Items del Carrito -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-gradient-secondary text-white" style="background: var(--dark-bg); border-radius: 15px 15px 0 0;">
                            <h5 class="mb-0">
                                <i class="bi bi-bag"></i> Productos en tu Carrito 
                                (<span id="totalItems" th:text="${itemCount}">0</span> items)
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- 
                              CORRECCIÓN: 
                              Se agrega th:if="${item.product != null}" para evitar errores
                              si un producto fue eliminado pero el item del carrito no.
                            -->
                            <th:block th:each="item : ${cartItems}">
                                <div class="border-bottom p-4" th:id="'cart-item-' + ${item.id}" th:if="${item.product != null}">
                                    <div class="row align-items-center">
                                        <!-- Imagen -->
                                        <div class="col-md-2">
                                            <img th:src="${item.product.imageUrl != null ? item.product.imageUrl : 'https://placehold.co/100x100/6c757d/ffffff?text=Sin+Imagen'}" 
                                                 th:alt="${item.product.name}" 
                                                 class="img-fluid rounded" 
                                                 style="width:100px; height:100px; object-fit:cover;"
                                                 onerror="this.src='https://placehold.co/100x100/6c757d/ffffff?text=Error'">
                                        </div>
                                        
                                        <!-- Info -->
                                        <div class="col-md-3">
                                            <h6 class="fw-bold mb-1" th:text="${item.product.name}">Producto</h6>
                                            <p class="text-muted small mb-1">
                                                <span th:if="${item.product.category}" th:text="${item.product.category.name}">Categoría</span>
                                            </p>
                                            <span th:if="${item.product.cantidad > 0}" class="badge bg-success">En Stock</span>
                                            <span th:unless="${item.product.cantidad > 0}" class="badge bg-danger">Agotado</span>
                                        </div>
                                        
                                        <!-- Precio Unitario -->
                                        <div class="col-md-2 text-center">
                                            <small class="text-muted d-block">Precio</small>
                                            <span class="fw-bold text-primary" th:text="${#numbers.formatCurrency(item.unitPrice)}">$0</span>
                                        </div>
                                        
                                        <!-- Cantidad -->
                                        <div class="col-md-2">
                                            <label class="form-label small">Cantidad</label>
                                            <div class="input-group input-group-sm">
                                                <button class="btn btn-outline-secondary" type="button" th:onclick="'updateQuantity(' + ${item.id} + ', ' + ${item.quantity - 1} + ')'">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="number" class="form-control text-center" th:id="'quantity-' + ${item.id}" th:value="${item.quantity}" min="1" th:max="${item.product.cantidad}" readonly>
                                                <button class="btn btn-outline-secondary" type="button" th:onclick="'updateQuantity(' + ${item.id} + ', ' + ${item.quantity + 1} + ')'">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Subtotal -->
                                        <div class="col-md-2 text-center">
                                            <small class="text-muted d-block">Subtotal</small>
                                            <span class="fw-bold text-success fs-5" th:id="'item-total-' + ${item.id}" th:text="${#numbers.formatCurrency(item.totalPrice)}">$0</span>
                                        </div>
                                        
                                        <!-- Eliminar -->
                                        <div class="col-md-1 text-end">
                                            <button class="btn btn-outline-danger btn-sm" th:onclick="'removeItem(' + ${item.id} + ')'">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-outline-danger" onclick="clearCart()">
                                    <i class="bi bi-trash"></i> Vaciar Carrito
                                </button>
                                <a href="/products" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-circle"></i> Agregar más productos
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen del Pedido -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                        <div class="card-header bg-gradient-secondary text-white" style="background: var(--dark-bg); border-radius: 15px 15px 0 0;">
                            <h5 class="mb-0">
                                <i class="bi bi-receipt"></i> Resumen del Pedido
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal (<span id="itemCountSummary" th:text="${itemCount}">0</span> items)</span>
                                <span id="subtotalAmount" th:text="${#numbers.formatCurrency(cartTotal)}">$0</span>
                            </div>
                            
                            <th:block th:with="shipping=${cartTotal >= 500000 ? 0 : 50000}, tax=${cartTotal * 0.19}, total=${cartTotal + tax + (cartTotal >= 500000 ? 0 : 50000)}">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Envío</span>
                                    <span th:classappend="${shipping == 0 ? 'text-success' : ''}" th:text="${shipping == 0 ? 'Gratis' : #numbers.formatCurrency(shipping)}">$0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Impuestos (19%)</span>
                                    <span id="taxAmount" th:text="${#numbers.formatCurrency(tax)}">$0</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-4">
                                    <strong class="fs-5">Total a Pagar</strong>
                                    <strong class="text-success fs-4" id="totalAmount" th:text="${#numbers.formatCurrency(total)}">$0</strong>
                                </div>
                                
                                <div class="alert alert-info small py-2 mb-3" th:if="${cartTotal < 500000}">
                                    <i class="bi bi-info-circle"></i>
                                    Agrega <strong th:text="${#numbers.formatCurrency(500000 - cartTotal)}">$0</strong> más para envío gratis
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a href="/payment/checkout" class="btn btn-success btn-lg">
                                        <i class="bi bi-credit-card"></i> Proceder al Pago
                                    </a>
                                </div>
                            </th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts (reutiliza el JS global de layout.html, pero agrega la lógica específica de esta página) -->
        <script th:inline="javascript">
            // CSRF Token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

            /**
             * Actualizar cantidad
             */
            function updateQuantity(itemId, newQuantity) {
                if (newQuantity < 1) {
                    removeItem(itemId); // Llama a eliminar si la cantidad es 0
                    return;
                }

                const formData = new URLSearchParams();
                formData.append('cartItemId', itemId);
                formData.append('quantity', newQuantity);

                fetch('/cart/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Recargar la página para recalcular todo
                        location.reload();
                    } else {
                        showGlobalNotification(data.message || 'Error al actualizar', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showGlobalNotification('Error al actualizar la cantidad', 'danger');
                });
            }

            /**
             * Eliminar item
             */
            function removeItem(itemId) {
                if (!confirm('¿Estás seguro de eliminar este producto?')) return;

                const formData = new URLSearchParams();
                formData.append('cartItemId', itemId);

                fetch('/cart/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Recargar la página para recalcular todo
                        location.reload();
                    } else {
                        showGlobalNotification(data.message || 'Error al eliminar', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showGlobalNotification('Error al eliminar el producto', 'danger');
                });
            }

            /**
             * Vaciar carrito
             */
            function clearCart() {
                if (!confirm('¿Estás seguro de vaciar todo el carrito?')) return;

                fetch('/cart/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', [csrfHeader]: csrfToken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload(); // Recargar la página
                    } else {
                        showGlobalNotification(data.message || 'Error al vaciar el carrito', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showGlobalNotification('Error al vaciar el carrito', 'danger');
                });
            }
        </script>
    </div>
</body>
</html>